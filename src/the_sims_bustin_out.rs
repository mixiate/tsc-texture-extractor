fn convert(bytes: &[u8]) -> image::RgbaImage {
    let bytes = &bytes[16 + 4..];
    let null_position = bytes.iter().position(|x| *x == 0).unwrap();

    let width = usize::from(u16::from_le_bytes(
        bytes[null_position + 3..null_position + 5].try_into().unwrap(),
    ));
    let height = usize::from(u16::from_le_bytes(
        bytes[null_position + 5..null_position + 7].try_into().unwrap(),
    ));

    if bytes[null_position + 1] == 0x8C {
        crate::deswizzle::deswizzle_xbox_rgba(&bytes[null_position + 21..], width, height)
    } else if bytes[null_position + 1] & 0b0000_0001 > 0 {
        let palette = &bytes[bytes.len() - 1024..];
        crate::deswizzle::deswizzle_xbox_palette(&bytes[null_position + 21..], width, height, palette)
    } else if bytes[null_position + 1] & 0b0001_0000 > 0 {
        crate::decompress_bc2(&bytes[null_position + 33..], width, height)
    } else {
        crate::decompress_bc1(&bytes[null_position + 33..], width, height)
    }
}

pub fn extract_textures(textures_path: &std::path::Path, output_path: &std::path::Path) {
    std::fs::create_dir_all(output_path).unwrap();

    let textures = std::fs::read(textures_path).unwrap();

    let files = crate::arc::read_le(&textures);

    for (name, id, bytes) in files {
        let image = convert(bytes);
        crate::save_texture(image, &name, output_path, !ALPHA_TEXTURE_IDS.contains(&id));
    }
}

pub fn extract_rle_textures(rletextures_path: &std::path::Path, output_path: &std::path::Path) {
    std::fs::create_dir_all(output_path).unwrap();

    let rletextures = std::fs::read(rletextures_path).unwrap();

    let files = crate::arc::read_le(&rletextures);

    for (name, _, bytes) in files {
        let image = crate::rle_textures::convert(bytes, true);
        crate::save_texture(image, &name, output_path, false);
    }
}

const ALPHA_TEXTURE_IDS: [u32; 1288] = [
    1003137059, 1007216883, 1008232004, 1011490186, 1017241056, 1017726417, 1021707584, 1025162370, 1027490000,
    1027830898, 1029845720, 1041591381, 10417810, 1045155067, 1049153561, 1049995869, 1053462612, 1053695429,
    1053858143, 1070139412, 1075099481, 1075297360, 1081271696, 1083566872, 1084523644, 108568300, 109404227,
    1095084670, 109882985, 1100729561, 1103347070, 1104889489, 1106518683, 1108905392, 1113192483, 1119873414,
    1127323391, 1133010945, 1134758172, 1143780422, 115029785, 1150563134, 1152923044, 1157213507, 1161274692,
    1164984965, 1166351504, 116841975, 1174014070, 1176179994, 1179076380, 1180097146, 1188249574, 1189052072,
    1191339711, 1195135903, 119772636, 1197852211, 1198418858, 1201043482, 1205195629, 1217631101, 1218230698,
    1226328230, 1232352795, 1233268748, 1234638057, 1239056513, 1239677257, 1244389650, 1245278278, 1245417741,
    1248132249, 1249571395, 1252095717, 1255063410, 1255837485, 1256090342, 1257131220, 1257237725, 1257503940,
    1259393632, 1259606538, 1261110206, 1262444187, 1264001149, 1269694521, 1269994351, 1273693135, 1274450240,
    1276315725, 1277270157, 1280285465, 1286366364, 1287508534, 1288102648, 1288377036, 1288452373, 1289837041,
    1291249694, 1291290073, 1295545505, 1296367975, 13017408, 1303845632, 1304982175, 1315341199, 133078983,
    1331533632, 1331962354, 133413070, 1336920589, 1337922196, 1338689808, 1343070128, 1344628705, 1346440349,
    1350167590, 1350672981, 135631981, 136419340, 1373351017, 1373949335, 1376136015, 1376713938, 1383022668,
    1383237537, 1386033521, 1390588579, 139826742, 1400828883, 1407477091, 1411746479, 1412058575, 1414048478,
    1416251667, 1417645673, 1419810240, 1420886656, 1424246970, 1428654390, 1432565963, 1433217178, 1433697163,
    1434089662, 1435061140, 1441725240, 144191926, 1443974675, 1446678859, 1449305614, 1461603095, 1462182578,
    1462759199, 1465381215, 1465783559, 1466329823, 1468857633, 1470829009, 1473366979, 1474889824, 1477772060,
    1479970249, 1480214735, 1480311207, 1483595842, 1487035380, 1489336542, 149102951, 1492521212, 1493845688,
    149398928, 1502150506, 1503029374, 1504277300, 1506509253, 15114695, 1519064306, 1523302966, 1527533412,
    1533038703, 1533373278, 1533636052, 1541183703, 1544393846, 1545909426, 1546718998, 1548992767, 1549758095,
    1549947424, 1554416462, 1554645435, 1556158422, 1556199192, 1557389459, 1557435452, 1557492960, 1559297877,
    1570207817, 1572227820, 1573030917, 1575455884, 1576251937, 1580087523, 1580766794, 1586525931, 1590152064,
    1594332643, 1595837517, 1597495125, 1597578849, 1602899597, 1608648492, 1610343532, 1610967325, 1618962974,
    1621704009, 162174801, 1629984905, 1630417159, 163427525, 1639307222, 1642686160, 1642731377, 1649243448,
    1650812077, 1673408593, 1674539178, 1675156705, 167722184, 1677525328, 1685554748, 1686103349, 1686966918,
    1687323529, 1688641269, 1691612232, 1691926367, 1692443373, 1694598327, 170128129, 1707541197, 1711984639,
    1712488681, 1713147342, 1714871382, 1717184190, 1724120033, 1724298698, 1729300395, 1729599332, 1739135853,
    1742327235, 1742784790, 1743128456, 174352019, 1744278501, 174460120, 1746678542, 1747609443, 1754282234,
    175653617, 1757423489, 1760235619, 1765860997, 1774751641, 1779256177, 1779484746, 1782706693, 1782784859,
    1784951381, 1785236087, 1785796291, 1788357632, 1790648562, 1792437045, 1792778332, 1793460482, 1794228327,
    179653103, 1797095305, 1803342740, 1804532905, 1808817067, 1808890490, 1821158806, 1824922885, 1825309254,
    1826830512, 183347545, 1837081202, 1838664256, 1842477967, 1845331078, 1845543411, 1849748447, 1856326528,
    1857468876, 1860374400, 1863510705, 1863522633, 1868918390, 187088903, 1876460084, 1877764757, 1877983896,
    1890741598, 1891629890, 1894963838, 1905958861, 1908446947, 1912319040, 1914321275, 1920407260, 1933271192,
    1934622088, 194092111, 194709201, 1948647159, 1957183462, 1957307289, 1958765649, 1959518161, 196045981,
    1965510880, 1967219292, 1967765105, 1970764196, 1979750871, 1981458480, 1982543632, 1986003589, 1988914299,
    1990159577, 1992090920, 1992242347, 2001417993, 2001722890, 2002244479, 2002685212, 200854220, 2009560654,
    2010307390, 2011493939, 2014061413, 2015532414, 2019945469, 2020004675, 2024338963, 2030708023, 2032899104,
    2036209049, 203987305, 2041225003, 20418280, 2042487142, 2042925928, 2044178191, 2047670359, 2052681589,
    2053029773, 2059725387, 2061671094, 2064241518, 2064958313, 2067067409, 2067305285, 2071564793, 2071623088,
    2073181763, 2082458760, 2082924324, 2083786102, 209141884, 2097150554, 2097190469, 2097523083, 2100462680,
    2103524430, 2107041810, 2118381817, 2119605054, 2121789640, 21221387, 212263823, 2123984306, 213120098, 2131928315,
    2133877158, 2142266108, 2142436463, 2158701228, 215920463, 2161850013, 2165970169, 2167138617, 2171004033,
    2179075001, 2180208016, 2188909313, 2196593052, 2197910411, 2198440095, 2203205568, 2206558571, 2207128846,
    2207948484, 221417447, 221570880, 221610029, 2216477396, 2216658529, 2218201646, 2223322642, 2223968065,
    2225820673, 2227200735, 2227222964, 2228750873, 2235573976, 2239356426, 2241201104, 2241842793, 2243426782,
    2245065734, 2246448632, 2249526228, 2249594791, 2251292824, 2254143153, 2257571744, 2262215845, 2262866179,
    2263451111, 2268591177, 2270185921, 2274728794, 2275093774, 2276020238, 2277961397, 2281482454, 2294208796,
    2296356619, 2299246849, 230506619, 2307708600, 2308099105, 2308678635, 2312590494, 231715389, 2322921011,
    232781777, 2329777508, 2330208824, 2331560374, 2334132517, 2340837946, 2341259573, 2341279030, 2354571453,
    2358050006, 2362289886, 2364222731, 236603892, 2368857811, 2370214731, 2371104946, 2371478361, 2376640643,
    2377142653, 2378665731, 2382458444, 2387018257, 2387263051, 2387356939, 2392716845, 2394543432, 23980616,
    2406272427, 2411915595, 241472884, 2417588152, 2427307407, 2427450440, 2427661703, 2427920644, 2429852991,
    2437902299, 2439669409, 2441164747, 2443129756, 2445326395, 2460368167, 2460391378, 2465307510, 2473298037,
    2473549154, 2474240608, 2476185009, 247887003, 2479533103, 2482634073, 2486935937, 2487013783, 248735013,
    2493555561, 2510053231, 2513944407, 2528106678, 2530461641, 2534331271, 25394345, 2541076638, 2547819041,
    254820213, 2555844068, 2559192339, 256033428, 2565056444, 2572217392, 2579146228, 2588499655, 2591764154,
    2591845755, 2592196798, 2603132394, 2612183905, 2618306036, 2618949150, 2624754, 2626785218, 2627411119,
    2627509826, 2634272892, 2634989106, 2638520620, 2641146252, 2649229063, 2651229738, 2656720934, 2658739978,
    265983603, 2660299806, 2662840942, 2663052482, 2664203840, 2665877561, 2667934101, 2668741700, 267568360,
    267664956, 2679542671, 2681085041, 2684413423, 2685195869, 268543566, 2686595841, 2689441662, 2692603900,
    2694535538, 2695339892, 2696564270, 269760317, 2722955761, 2724117146, 2729939624, 2731272513, 2745165534,
    2752207135, 2754366619, 2754556187, 2755072362, 2758856150, 2764009223, 2765347564, 2766906528, 2769062070,
    2772187355, 2773058844, 2782856335, 2784383669, 2788093986, 2790726837, 2797733825, 2804408394, 2806555415,
    2810576565, 2810625318, 2812555109, 2815237127, 2827984955, 2836190231, 2838639283, 2844601971, 2852910636,
    2854222844, 2858321255, 2858715097, 2859913541, 2863502945, 2863917679, 2864082130, 2864864804, 2864893301,
    2866210073, 2868629266, 2873581897, 2874575490, 2875186380, 2876201564, 2878878606, 2879173246, 2881389357,
    2885335862, 2886981804, 2887499265, 2889079401, 2890185211, 2891548407, 2893771846, 289669205, 2898387169,
    2899606039, 2902746137, 2902749735, 2904361628, 2905953903, 2906161201, 2909284774, 2911415413, 2912346100,
    291313192, 2914729667, 2915328075, 2918081250, 2922001328, 2922004430, 2925431058, 2925524650, 2925909161,
    292676034, 2932104021, 2932396500, 2933124395, 29332562, 293531177, 2936010707, 2941492681, 2944825079, 294516232,
    2945914693, 2955931886, 2958314906, 2959729549, 2961039999, 2970502519, 2975628200, 2984657287, 2985333857,
    2987623835, 2988326026, 2991223848, 2993367150, 2999513840, 300312616, 3005348502, 3008537242, 3023284336,
    302663140, 3028695178, 3029379834, 3031148623, 3034615717, 3037354976, 3037961552, 3039454433, 3043897667,
    305776020, 3059740132, 3059974510, 3060331268, 3063661509, 3069076626, 3070502804, 3074002770, 3077232072,
    3077725936, 3078871805, 3084690296, 308897742, 3090477159, 3093171836, 3094203662, 3099323433, 310658188,
    3114071745, 3114951887, 3116381288, 3126237093, 3131203056, 3144505831, 3148953073, 3151434702, 3154157054,
    3168304488, 3171769308, 3178408279, 3187136318, 3188610697, 3189009872, 3191667735, 3197602794, 319803686,
    3200775131, 3206277125, 3210944854, 3212735374, 3213631581, 3215549649, 3216633386, 3221427970, 3227719067,
    3230720697, 3231349360, 3234140668, 3237336733, 3244601848, 3246167325, 32478091, 3248966318, 3250834296,
    3252274669, 3261661653, 3264877527, 3265557324, 3270179805, 3276131022, 3277859306, 3279685349, 3284688153,
    3285457275, 3290589204, 3291648895, 3294249339, 329524687, 3296697423, 3298465598, 3298525620, 3303023766,
    3303708002, 3305424332, 3306924740, 3308672517, 331294643, 3322508769, 3324783460, 3325054939, 332711134,
    3327564119, 3328677016, 3341452290, 3342618146, 3343563308, 3344137181, 3345928987, 3372557755, 3378341167,
    3382922934, 3386663827, 3388967833, 3390537871, 3391859656, 3404548768, 3406277992, 3410218975, 3413722430,
    3420706462, 3421139315, 3421527797, 342181420, 3424032895, 3426073928, 34267919, 34272474, 3427562622, 3429525873,
    3434580443, 3434688824, 3439601010, 3441661373, 3441868021, 3442576084, 3442715759, 344979060, 3451942582,
    3453820638, 345553542, 3459051679, 346070000, 3467261173, 3467825841, 3469078352, 3472987770, 3473496253,
    347598269, 347668679, 3481223932, 3483279407, 3496462605, 3496678449, 3502132539, 3509503647, 3514789063,
    352066063, 3523085493, 3523119423, 3531571104, 3532720995, 3542827133, 3547923259, 3549239880, 3551083985,
    3553081869, 3564552205, 356850608, 357077011, 3572847528, 3573474162, 3580089168, 3583802293, 358452159,
    3584586420, 3585156041, 3586278262, 3586454964, 3588655863, 3590776745, 3591220709, 3593204301, 3594491279,
    3594691462, 3595880186, 3596232220, 3599436608, 3602611777, 3603060407, 3604135518, 3605105476, 3606130431,
    3606918045, 3612592307, 3614986320, 3620518258, 3625241816, 362957598, 3633912956, 3643100216, 3643117189,
    3646252605, 3646473788, 3654497979, 3655814454, 3658812525, 3661607079, 3663149499, 3665899963, 3669440770,
    3669875304, 3675618892, 3679682318, 3682841709, 3685511069, 368653731, 3691171751, 3703950872, 3703964759,
    3705095362, 3713141306, 3713291432, 3715338281, 3716492910, 372235522, 3723100074, 3723595531, 3726385834,
    3727396960, 372798571, 3736264693, 3736876954, 3739061382, 3743059587, 3751742040, 3753540032, 3755737937,
    376089901, 3761983854, 3763587318, 3768880134, 376956273, 377080618, 3771141602, 3771354191, 3772813899,
    3777638017, 3777779155, 3779550634, 3785691707, 3788446092, 3791205845, 3794464525, 379451505, 3794615328,
    3796216581, 3796562426, 3801837561, 3804038140, 3805184559, 3806319493, 3812352257, 3812847567, 3822209667,
    3823481500, 3823653625, 3827310087, 3830456958, 3832049140, 3834914657, 3840968921, 3849826163, 3852537265,
    3858148320, 3859347384, 3859885544, 3860938752, 3861434745, 3866109681, 3868790262, 38700775, 3870919216,
    3871310918, 3873008818, 3881888001, 3882288716, 3887558208, 3887742429, 3894191469, 3895184503, 3895653159,
    3895797471, 3896263654, 3898516171, 3899115774, 3903643023, 3918954636, 3919196258, 392082191, 3926458756,
    3927296985, 3927508459, 3932916013, 3946757594, 3949257834, 3954469442, 3959808793, 3963850692, 3964937454,
    3967691128, 3974609278, 3980414077, 3980589276, 3988071858, 3990097751, 3990990357, 3991664617, 399429541,
    3994773331, 399518387, 3996942180, 3998735526, 4004488851, 401115108, 4012319728, 4020751368, 402096425, 4024935,
    4033164180, 4037294709, 4038751372, 4039237155, 4048345240, 4049251953, 4052287286, 4058721456, 4062451833,
    4065304847, 4068230404, 406894218, 4069339606, 4070264846, 407853649, 4079904814, 408261476, 4085525899,
    4088378789, 4091493007, 4094051101, 4096302427, 4098835012, 409953985, 4099582862, 4100648395, 4105846596,
    4110115042, 4110644604, 4111378166, 4116212080, 4125688322, 4125780234, 4126537960, 4128217688, 4132809948,
    4135079427, 41366933, 4138327788, 4139965049, 4142218031, 4142484196, 4146006174, 4150024347, 4150267802,
    4152131868, 4154714695, 4155251258, 415629578, 4161563727, 4162965224, 4168890676, 4171741962, 417553655,
    418077187, 4184959289, 4188588636, 4192286076, 4193624305, 4196872593, 4197423293, 4197615328, 4203802357,
    4203973361, 4204670347, 4206153967, 4206322155, 4207748361, 420782879, 4208405807, 4212583572, 4216294935,
    4216468585, 4225541191, 4229405914, 423104807, 4231701589, 4233426154, 4234824766, 4236890250, 4236912032,
    4238057326, 4239331921, 4248413500, 4249251603, 4249441154, 4250751316, 4252021822, 4252500285, 4258964978,
    4259886148, 4264965753, 4266115354, 4268818252, 4277236286, 4280586011, 4284297777, 4284981157, 4286415847,
    4287218951, 428917646, 4290935882, 4292635320, 4293212945, 430078742, 434597786, 436763057, 437832293, 447633800,
    451125874, 454269743, 454516837, 460676405, 462591914, 465918780, 467929126, 47115438, 477497476, 478792767,
    481343781, 485386940, 490705752, 496577278, 501466342, 503172418, 50335691, 509155451, 516931343, 517058512,
    519925788, 528915994, 529246059, 52969811, 538275250, 539350939, 542255949, 548480837, 5497670, 550391901,
    557687261, 560305816, 563242833, 566026404, 568479971, 571033496, 571147003, 576981085, 582808648, 591982791,
    59374018, 59846215, 605031556, 611415631, 615921437, 616615061, 62030296, 620615353, 621399108, 626361102,
    627120159, 627776854, 631317410, 634740547, 634765663, 638448324, 639972566, 642873603, 645101320, 646366619,
    651992319, 653851785, 65528794, 655799735, 65931295, 666581509, 66663410, 670996900, 671552717, 674876796,
    675180585, 679677762, 683214849, 685675725, 685847665, 686129121, 690348767, 697602777, 698643521, 698720625,
    701517177, 7045294, 705153205, 706437870, 709355538, 712213088, 721083274, 721646649, 722117856, 724975488,
    72608467, 728476352, 731469071, 733135478, 733254870, 7335304, 735200374, 735632034, 73853897, 739310956,
    739350522, 739676171, 740550028, 751783946, 752640368, 754394072, 756329597, 758342161, 759903044, 762048732,
    763608004, 764373296, 766149266, 769874877, 772634158, 774641255, 775811512, 776802650, 781940225, 783129770,
    784421148, 784588093, 788336269, 794703306, 795529428, 799017855, 799670704, 801771045, 805711295, 809198345,
    813172339, 822855662, 82541599, 829847645, 830187469, 835520331, 837610493, 841426323, 843187603, 844997033,
    845548518, 845649179, 846173199, 847269431, 847391750, 848501358, 849102219, 856096440, 857094587, 868540834,
    873723298, 874181057, 874552359, 876295113, 887205141, 888611831, 893049386, 896259815, 897981551, 900481858,
    906437155, 906872663, 912134021, 921534840, 925402819, 925626281, 926607369, 927485563, 929342389, 931417523,
    934026351, 934333777, 934979593, 937570230, 940790657, 943654919, 945236217, 945639549, 947644394, 954959046,
    962042970, 964120104, 968471231, 97009927, 970775338, 97218763, 977011075, 977443284, 978642866, 982861587,
    985852493, 986303700, 994415533, 994659692,
];
